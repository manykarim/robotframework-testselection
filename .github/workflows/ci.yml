name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  lint:
    name: Lint & Type Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Set up Python
        run: uv python install 3.11

      - name: Install dependencies
        run: uv sync --extra dev

      - name: Ruff check
        run: uv run ruff check src/ tests/

      - name: Mypy
        run: uv run mypy src/

  test:
    name: Test (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10", "3.11", "3.12", "3.13"]
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Set up Python ${{ matrix.python-version }}
        run: uv python install ${{ matrix.python-version }}

      - name: Install dependencies
        run: uv sync --extra dev

      - name: Run unit tests with coverage
        run: |
          uv run pytest tests/unit/ \
            --cov=TestSelection \
            --cov-report=term-missing \
            --cov-report=xml:coverage.xml \
            --cov-report=html:htmlcov/ \
            -v \
            --benchmark-disable

      - name: Upload coverage report
        if: matrix.python-version == '3.11'
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: |
            coverage.xml
            htmlcov/
          retention-days: 14

      - name: Coverage threshold check
        if: matrix.python-version == '3.11'
        run: |
          uv run python -c "
          import xml.etree.ElementTree as ET
          tree = ET.parse('coverage.xml')
          rate = float(tree.getroot().attrib['line-rate'])
          pct = rate * 100
          print(f'Coverage: {pct:.1f}%')
          if pct < 60:
              raise SystemExit(f'Coverage {pct:.1f}% is below 60% threshold')
          "

  build:
    name: Build Package
    needs: [lint, test]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Set up Python
        run: uv python install 3.11

      - name: Build wheel and sdist
        run: uv build

      - name: Verify wheel contents
        run: |
          python3 -c "
          import zipfile, sys
          whl = list(__import__('pathlib').Path('dist').glob('*.whl'))[0]
          with zipfile.ZipFile(whl) as z:
              names = z.namelist()
              ts_files = [n for n in names if n.startswith('TestSelection/')]
              print(f'Wheel: {whl.name}')
              print(f'TestSelection files: {len(ts_files)}')
              for f in sorted(ts_files):
                  print(f'  {f}')
              if not ts_files:
                  sys.exit('ERROR: No TestSelection files in wheel')
          "

      - name: Verify sdist contents
        run: |
          python3 -c "
          import tarfile, sys
          sdist = list(__import__('pathlib').Path('dist').glob('*.tar.gz'))[0]
          with tarfile.open(sdist) as t:
              names = t.getnames()
              ts_files = [n for n in names if '/src/TestSelection/' in n]
              print(f'Sdist: {sdist.name}')
              print(f'TestSelection files: {len(ts_files)}')
              if not ts_files:
                  sys.exit('ERROR: No TestSelection files in sdist')
          "

      - name: Test install from wheel
        run: |
          uv venv /tmp/test-install
          VIRTUAL_ENV=/tmp/test-install uv pip install dist/*.whl
          /tmp/test-install/bin/python -c "from TestSelection.cli import main; print('Import OK')"
          /tmp/test-install/bin/testcase-select --help

      - name: Upload dist artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/
          retention-days: 7
